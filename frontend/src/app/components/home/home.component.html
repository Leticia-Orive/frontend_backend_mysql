<div class="home-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>ğŸ›’ Tienda Online</h1>
      <div class="header-actions">
        <!-- Not logged in -->
        <div *ngIf="!currentUser" class="auth-buttons">
          <button class="btn-login" routerLink="/login">
            ğŸ” Iniciar SesiÃ³n
          </button>
          <button class="btn-register" routerLink="/register">
            ğŸ“ Registrarse
          </button>
        </div>
        
        <!-- Logged in -->
        <div *ngIf="currentUser" class="user-section">
          <span class="welcome-text">
            Hola, {{ currentUser.name }}
            <span class="role-badge" [class.admin]="currentUser.role === 'admin'">
              {{ currentUser.role === 'admin' ? 'Admin' : 'User' }}
            </span>
          </span>
          <button 
            *ngIf="currentUser?.role === 'admin'" 
            class="btn-admin" 
            (click)="goToUsers()">
            ğŸ‘¥ Usuarios
          </button>
          <button class="btn-logout" (click)="logout()">
            ğŸšª Salir
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Coupons Notification -->
  <div *ngIf="currentUser && userCoupons.length > 0 && showCouponsNotification" class="coupons-notification">
    <div class="notification-content">
      <button class="btn-close-notification" (click)="showCouponsNotification = false">âœ–</button>
      <div class="notification-icon">ğŸ</div>
      <div class="notification-text">
        <h3>Â¡Tienes {{ userCoupons.length }} cupÃ³n{{ userCoupons.length > 1 ? 'es' : '' }} disponible{{ userCoupons.length > 1 ? 's' : '' }}!</h3>
        <div class="coupon-list">
          <div *ngFor="let coupon of userCoupons" class="coupon-item">
            <span class="coupon-code">{{ coupon.coupon_code }}</span>
            <span class="coupon-amount">â‚¬{{ coupon.discount_amount }}</span>
          </div>
        </div>
        <p class="notification-hint">Ãšsalos en el carrito para obtener descuentos</p>
      </div>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="category-filter">
    <button 
      class="filter-btn" 
      [class.active]="selectedCategory === null"
      (click)="filterByCategory(null)">
      Todas
    </button>
    <button 
      *ngFor="let category of categories"
      class="filter-btn" 
      [class.active]="selectedCategory === category.id"
      (click)="filterByCategory(category.id)">
      {{ category.name }}
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando productos...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Products by Category -->
  <div *ngIf="!loading && !error" class="products-container">
    <div *ngFor="let category of getFilteredCategories()" class="category-section">
      <div class="category-header">
        <img [src]="category.image_url" [alt]="category.name" class="category-image">
        <div class="category-info">
          <h2>{{ category.name }}</h2>
          <p>{{ category.description }}</p>
        </div>
      </div>

      <div *ngIf="productsByCategory[category.id]?.length === 0" class="no-products">
        No hay productos en esta categorÃ­a
      </div>

      <!-- Add Product Button for Admin -->
      <div *ngIf="isAdmin()" class="add-product-section">
        <button class="btn-add-product" (click)="openCreateProductForm()">
          â• AÃ±adir Nuevo Producto a {{ category.name }}
        </button>
      </div>

      <div class="products-grid">
        <div *ngFor="let product of productsByCategory[category.id]" class="product-card">
          <div class="product-image-container">
            <img [src]="product.image_url" [alt]="product.name" class="product-image">
            <span *ngIf="product.stock === 0" class="out-of-stock">Agotado</span>
            <span *ngIf="product.stock > 0 && product.stock < 10" class="low-stock">Ãšltimas unidades</span>
          </div>
          <div class="product-info">
            <h3 class="product-name">{{ product.name }}</h3>
            <p class="product-description">{{ product.description }}</p>
            <div class="product-footer">
              <span class="product-price">{{ product.price | currency:'EUR':'symbol':'1.2-2' }}</span>
              <span class="product-stock">Stock: {{ product.stock }}</span>
            </div>
            
            <!-- Admin Buttons -->
            <div *ngIf="isAdmin()" class="admin-buttons">
              <button class="btn-edit" (click)="openEditProductForm(product)">
                âœï¸ Editar
              </button>
              <button class="btn-delete" (click)="deleteProduct(product)">
                ğŸ—‘ï¸ Eliminar
              </button>
            </div>
            
            <!-- User Buttons (only when logged in and not admin) -->
            <div *ngIf="currentUser && !isAdmin()" class="user-buttons">
              <button class="btn-view-product" (click)="viewProduct(product)">
                ğŸ‘ï¸ Ver Producto
              </button>
            </div>
            
            <!-- Add to Cart Button (for all users) -->
            <button 
              class="btn-add-cart" 
              [disabled]="product.stock === 0"
              [class.disabled]="product.stock === 0"
              (click)="addToCart(product)">
              {{ product.stock === 0 ? 'Agotado' : 'ğŸ›’ AÃ±adir al Carrito' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Form Modal (Admin Only) -->
  <div *ngIf="showProductForm" class="modal-overlay" (click)="closeProductForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>{{ isEditingProduct ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
      
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" [(ngModel)]="currentProduct.name" placeholder="Nombre del producto">
      </div>

      <div class="form-group">
        <label>DescripciÃ³n</label>
        <textarea [(ngModel)]="currentProduct.description" placeholder="DescripciÃ³n del producto"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Precio (â‚¬) *</label>
          <input type="number" [(ngModel)]="currentProduct.price" placeholder="0.00" step="0.01">
        </div>

        <div class="form-group">
          <label>Stock *</label>
          <input type="number" [(ngModel)]="currentProduct.stock" placeholder="0">
        </div>
      </div>

      <div class="form-group">
        <label>CategorÃ­a *</label>
        <select [(ngModel)]="currentProduct.category_id">
          <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>URL de la Imagen</label>
        <input type="text" [(ngModel)]="currentProduct.image_url" placeholder="https://...">
      </div>

      <div class="form-actions">
        <button class="btn-cancel" (click)="closeProductForm()">Cancelar</button>
        <button class="btn-save" (click)="saveProduct()">
          {{ isEditingProduct ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div *ngIf="showProductDetail && selectedProduct" class="modal-overlay" (click)="closeProductDetail()">
    <div class="modal-content product-detail-modal" (click)="$event.stopPropagation()">
      <button class="btn-close-modal" (click)="closeProductDetail()">âœ•</button>
      
      <div class="product-detail-content">
        <div class="product-detail-image">
          <img [src]="selectedProduct.image_url" [alt]="selectedProduct.name">
          <span *ngIf="selectedProduct.stock === 0" class="badge-out-of-stock">Agotado</span>
          <span *ngIf="selectedProduct.stock > 0 && selectedProduct.stock < 10" class="badge-low-stock">
            Â¡Solo quedan {{ selectedProduct.stock }}!
          </span>
        </div>
        
        <div class="product-detail-info">
          <h2>{{ selectedProduct.name }}</h2>
          
          <div class="product-category-badge">
            ğŸ“¦ {{ selectedProduct.category_name }}
          </div>
          
          <div class="product-price-section">
            <span class="price-label">Precio:</span>
            <span class="price-value">{{ selectedProduct.price | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          
          <div class="product-description-full">
            <h3>DescripciÃ³n</h3>
            <p>{{ selectedProduct.description }}</p>
          </div>
          
          <div class="product-specifications">
            <h3>Especificaciones</h3>
            <div class="spec-item">
              <span class="spec-label">ğŸ“¦ Stock disponible:</span>
              <span class="spec-value">{{ selectedProduct.stock }} unidades</span>
            </div>
            <div class="spec-item">
              <span class="spec-label">ğŸ·ï¸ CategorÃ­a:</span>
              <span class="spec-value">{{ selectedProduct.category_name }}</span>
            </div>
            <div class="spec-item">
              <span class="spec-label">ğŸ†” ID del producto:</span>
              <span class="spec-value">#{{ selectedProduct.id }}</span>
            </div>
            <div class="spec-item" *ngIf="selectedProduct.created_at">
              <span class="spec-label">ğŸ“… Fecha de publicaciÃ³n:</span>
              <span class="spec-value">{{ selectedProduct.created_at | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
          
          <div class="product-actions">
            <button 
              class="btn-add-to-cart-detail" 
              [disabled]="selectedProduct.stock === 0"
              [class.disabled]="selectedProduct.stock === 0"
              (click)="addToCartFromDetail()">
              {{ selectedProduct.stock === 0 ? 'âŒ Producto Agotado' : 'ğŸ›’ AÃ±adir al Carrito' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shopping Cart Button -->
  <div class="cart-button" *ngIf="cart.length > 0">
    <button class="btn-cart" (click)="showCart = !showCart">
      ğŸ›’ Carrito ({{ cart.length }})
      <span class="cart-total">{{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}</span>
    </button>
  </div>

  <!-- Cart Modal -->
  <div *ngIf="showCart" class="modal-overlay" (click)="showCart = false">
    <div class="modal-content cart-modal" (click)="$event.stopPropagation()">
      <h2>ğŸ›’ Mi Carrito</h2>
      
      <div *ngIf="cart.length === 0" class="empty-cart">
        El carrito estÃ¡ vacÃ­o
      </div>

      <div *ngIf="cart.length > 0" class="cart-items">
        <div *ngFor="let item of cart; let i = index" class="cart-item">
          <img [src]="item.product.image_url" [alt]="item.product.name">
          <div class="cart-item-info">
            <h4>{{ item.product.name }}</h4>
            <p>{{ item.product.price | currency:'EUR':'symbol':'1.2-2' }}</p>
          </div>
          <div class="cart-item-quantity">
            <button (click)="updateQuantity(i, item.quantity - 1)">-</button>
            <span>{{ item.quantity }}</span>
            <button (click)="updateQuantity(i, item.quantity + 1)">+</button>
          </div>
          <div class="cart-item-total">
            {{ (item.product.price * item.quantity) | currency:'EUR':'symbol':'1.2-2' }}
          </div>
          <button class="btn-remove" (click)="removeFromCart(i)">ğŸ—‘ï¸</button>
        </div>
      </div>

      <div *ngIf="cart.length > 0" class="cart-footer">
        <!-- Coupon Section -->
        <div class="cart-coupon-section">
          <h4>Â¿Tienes un cupÃ³n?</h4>
          <div class="coupon-input-group">
            <input 
              type="text" 
              [(ngModel)]="couponCode" 
              placeholder="Ingresa tu cupÃ³n"
              [disabled]="appliedCoupon !== null"
            >
            <button 
              *ngIf="!appliedCoupon" 
              class="btn-apply-coupon" 
              (click)="applyCoupon()"
              [disabled]="!couponCode"
            >
              Aplicar
            </button>
            <button 
              *ngIf="appliedCoupon" 
              class="btn-remove-coupon" 
              (click)="removeCoupon()"
            >
              Eliminar
            </button>
          </div>
          <p *ngIf="appliedCoupon" class="coupon-applied">
            âœ“ CupÃ³n {{ appliedCoupon }} aplicado
          </p>
        </div>

        <!-- Total Section -->
        <div class="cart-total-section">
          <div class="total-line">
            <span>Subtotal:</span>
            <span>{{ cartSubtotal | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div *ngIf="currentUser" class="total-line discount">
            <span>ğŸ Descuento usuario (10%):</span>
            <span>-{{ cartDiscount | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div *ngIf="appliedCoupon" class="total-line discount">
            <span>ğŸŸï¸ CupÃ³n {{ appliedCoupon }}:</span>
            <span>-{{ couponDiscount | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-line total">
            <span><strong>Total:</strong></span>
            <span><strong>{{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}</strong></span>
          </div>
          <div *ngIf="!currentUser" class="register-promo">
            ğŸ’¡ Â¡RegÃ­strate y obtÃ©n 10% de descuento en todas tus compras!
          </div>
        </div>

        <div class="cart-actions">
          <button class="btn-clear" (click)="clearCart()">Vaciar Carrito</button>
          <button class="btn-checkout" (click)="proceedToCheckout()">Proceder al Pago</button>
        </div>
      </div>
    </div>
  </div>
</div>
