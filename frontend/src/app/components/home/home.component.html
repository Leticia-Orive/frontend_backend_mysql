<div class="home-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>üõí Tienda Online</h1>
      <div class="header-actions">
        <!-- Not logged in -->
        <div *ngIf="!currentUser" class="auth-buttons">
          <button class="btn-login" routerLink="/login">
            üîê Iniciar Sesi√≥n
          </button>
          <button class="btn-register" routerLink="/register">
            üìù Registrarse
          </button>
        </div>
        
        <!-- Logged in -->
        <div *ngIf="currentUser" class="user-section">
          <span class="welcome-text">
            Hola, {{ currentUser.name }}
            <span class="role-badge" [class.admin]="currentUser.role === 'admin'">
              {{ currentUser.role === 'admin' ? 'Admin' : 'User' }}
            </span>
          </span>
          <button 
            *ngIf="currentUser?.role === 'admin'" 
            class="btn-admin" 
            (click)="goToUsers()">
            üë• Usuarios
          </button>
          <button class="btn-logout" (click)="logout()">
            üö™ Salir
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Coupons Notification -->
  <div *ngIf="currentUser && userCoupons.length > 0 && showCouponsNotification" class="coupons-notification">
    <div class="notification-content">
      <button class="btn-close-notification" (click)="showCouponsNotification = false">‚úñ</button>
      <div class="notification-icon">üéÅ</div>
      <div class="notification-text">
        <h3>¬°Tienes {{ userCoupons.length }} cup√≥n{{ userCoupons.length > 1 ? 'es' : '' }} disponible{{ userCoupons.length > 1 ? 's' : '' }}!</h3>
        <div class="coupon-list">
          <div *ngFor="let coupon of userCoupons" class="coupon-item">
            <span class="coupon-code">{{ coupon.coupon_code }}</span>
            <span class="coupon-amount">‚Ç¨{{ coupon.discount_amount }}</span>
          </div>
        </div>
        <p class="notification-hint">√ösalos en el carrito para obtener descuentos</p>
      </div>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="category-filter">
    <button 
      class="filter-btn" 
      [class.active]="selectedCategory === null"
      (click)="filterByCategory(null)">
      Todas
    </button>
    <button 
      *ngFor="let category of categories"
      class="filter-btn" 
      [class.active]="selectedCategory === category.id"
      (click)="filterByCategory(category.id)">
      {{ category.name }}
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando productos...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Products by Category -->
  <div *ngIf="!loading && !error" class="products-container">
    <div *ngFor="let category of getFilteredCategories()" class="category-section">
      <div class="category-header">
        <img [src]="category.image_url" [alt]="category.name" class="category-image">
        <div class="category-info">
          <h2>{{ category.name }}</h2>
          <p>{{ category.description }}</p>
        </div>
      </div>

      <div *ngIf="productsByCategory[category.id]?.length === 0" class="no-products">
        No hay productos en esta categor√≠a
      </div>

      <!-- Add Product Button for Admin -->
      <div *ngIf="isAdmin()" class="add-product-section">
        <button class="btn-add-product" (click)="openCreateProductForm()">
          ‚ûï A√±adir Nuevo Producto a {{ category.name }}
        </button>
      </div>

      <div class="products-grid">
        <div *ngFor="let product of productsByCategory[category.id]" class="product-card">
          <div class="product-image-container">
            <img [src]="product.image_url" [alt]="product.name" class="product-image">
            <span *ngIf="product.stock === 0" class="out-of-stock">Agotado</span>
            <span *ngIf="product.stock > 0 && product.stock < 10" class="low-stock">√öltimas unidades</span>
          </div>
          <div class="product-info">
            <h3 class="product-name">{{ product.name }}</h3>
            <p class="product-description">{{ product.description }}</p>
            <div class="product-footer">
              <span class="product-price">{{ product.price | currency:'EUR':'symbol':'1.2-2' }}</span>
              <span class="product-stock">Stock: {{ product.stock }}</span>
            </div>
            
            <!-- Admin Buttons -->
            <div *ngIf="isAdmin()" class="admin-buttons">
              <button class="btn-edit" (click)="openEditProductForm(product)">
                ‚úèÔ∏è Editar
              </button>
              <button class="btn-delete" (click)="deleteProduct(product)">
                üóëÔ∏è Eliminar
              </button>
            </div>
            
            <!-- User Buttons (only when logged in and not admin) -->
            <div *ngIf="currentUser && !isAdmin()" class="user-buttons">
              <button class="btn-view-product" (click)="viewProduct(product)">
                üëÅÔ∏è Ver Producto
              </button>
            </div>
            
            <!-- Add to Cart Button (for all users) -->
            <button 
              class="btn-add-cart" 
              [disabled]="product.stock === 0"
              [class.disabled]="product.stock === 0"
              (click)="addToCart(product)">
              {{ product.stock === 0 ? 'Agotado' : 'üõí A√±adir al Carrito' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Form Modal (Admin Only) -->
  <div *ngIf="showProductForm" class="modal-overlay" (click)="closeProductForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>{{ isEditingProduct ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
      
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" [(ngModel)]="currentProduct.name" placeholder="Nombre del producto">
      </div>

      <div class="form-group">
        <label>Descripci√≥n</label>
        <textarea [(ngModel)]="currentProduct.description" placeholder="Descripci√≥n del producto"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Precio (‚Ç¨) *</label>
          <input type="number" [(ngModel)]="currentProduct.price" placeholder="0.00" step="0.01">
        </div>

        <div class="form-group">
          <label>Stock *</label>
          <input type="number" [(ngModel)]="currentProduct.stock" placeholder="0">
        </div>
      </div>

      <div class="form-group">
        <label>Categor√≠a *</label>
        <select [(ngModel)]="currentProduct.category_id">
          <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>URL de la Imagen</label>
        <input type="text" [(ngModel)]="currentProduct.image_url" placeholder="https://...">
      </div>

      <div class="form-actions">
        <button class="btn-cancel" (click)="closeProductForm()">Cancelar</button>
        <button class="btn-save" (click)="saveProduct()">
          {{ isEditingProduct ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div *ngIf="showProductDetail && selectedProduct" class="modal-overlay" (click)="closeProductDetail()">
    <div class="modal-content product-detail-modal" (click)="$event.stopPropagation()">
      <button class="btn-close-modal" (click)="closeProductDetail()">‚úï</button>
      
      <div class="product-detail-content">
        <div class="product-detail-image">
          <img [src]="selectedProduct.image_url" [alt]="selectedProduct.name">
          <span *ngIf="selectedProduct.stock === 0" class="badge-out-of-stock">Agotado</span>
          <span *ngIf="selectedProduct.stock > 0 && selectedProduct.stock < 10" class="badge-low-stock">
            ¬°Solo quedan {{ selectedProduct.stock }}!
          </span>
        </div>
        
        <div class="product-detail-info">
          <h2>{{ selectedProduct.name }}</h2>
          
          <div class="product-category-badge">
            üì¶ {{ selectedProduct.category_name }}
          </div>
          
          <div class="product-price-section">
            <span class="price-label">Precio:</span>
            <span class="price-value">{{ selectedProduct.price | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          
          <div class="product-description-full">
            <h3>Descripci√≥n</h3>
            <p>{{ selectedProduct.description }}</p>
          </div>
          
          <div class="product-specifications">
            <h3>Especificaciones</h3>
            <div class="spec-item">
              <span class="spec-label">üì¶ Stock disponible:</span>
              <span class="spec-value">{{ selectedProduct.stock }} unidades</span>
            </div>
            <div class="spec-item">
              <span class="spec-label">üè∑Ô∏è Categor√≠a:</span>
              <span class="spec-value">{{ selectedProduct.category_name }}</span>
            </div>
            <div class="spec-item">
              <span class="spec-label">üÜî ID del producto:</span>
              <span class="spec-value">#{{ selectedProduct.id }}</span>
            </div>
            <div class="spec-item" *ngIf="selectedProduct.created_at">
              <span class="spec-label">üìÖ Fecha de publicaci√≥n:</span>
              <span class="spec-value">{{ selectedProduct.created_at | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
          
          <div class="product-actions">
            <button 
              class="btn-add-to-cart-detail" 
              [disabled]="selectedProduct.stock === 0"
              [class.disabled]="selectedProduct.stock === 0"
              (click)="addToCartFromDetail()">
              {{ selectedProduct.stock === 0 ? '‚ùå Producto Agotado' : 'üõí A√±adir al Carrito' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shopping Cart Button -->
  <div class="cart-button" *ngIf="cart.length > 0">
    <button class="btn-cart" (click)="showCart = !showCart">
      üõí Carrito ({{ cart.length }})
      <span class="cart-total">{{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}</span>
    </button>
  </div>

  <!-- Cart Modal -->
  <div *ngIf="showCart" class="modal-overlay" (click)="showCart = false">
    <div class="modal-content cart-modal" (click)="$event.stopPropagation()">
      <h2>üõí Mi Carrito</h2>
      
      <div *ngIf="cart.length === 0" class="empty-cart">
        El carrito est√° vac√≠o
      </div>

      <div *ngIf="cart.length > 0" class="cart-items">
        <div *ngFor="let item of cart; let i = index" class="cart-item">
          <img [src]="item.product.image_url" [alt]="item.product.name">
          <div class="cart-item-info">
            <h4>{{ item.product.name }}</h4>
            <p>{{ item.product.price | currency:'EUR':'symbol':'1.2-2' }}</p>
          </div>
          <div class="cart-item-quantity">
            <button (click)="updateQuantity(i, item.quantity - 1)">-</button>
            <span>{{ item.quantity }}</span>
            <button (click)="updateQuantity(i, item.quantity + 1)">+</button>
          </div>
          <div class="cart-item-total">
            {{ (item.product.price * item.quantity) | currency:'EUR':'symbol':'1.2-2' }}
          </div>
          <button class="btn-remove" (click)="removeFromCart(i)">üóëÔ∏è</button>
        </div>
      </div>

      <div *ngIf="cart.length > 0" class="cart-footer">
        <!-- Coupon Section -->
        <div class="cart-coupon-section">
          <h4>¬øTienes un cup√≥n?</h4>
          
          <!-- Available Coupons for registered users -->
          <div *ngIf="currentUser && userCoupons.length > 0" class="available-coupons">
            <p class="coupons-title">üéÅ Tus cupones disponibles ({{ userCoupons.length }}):</p>
            <div class="coupons-grid">
              <div 
                *ngFor="let coupon of userCoupons" 
                class="coupon-card"
                (click)="applyUserCoupon(coupon.coupon_code)">
                <div class="coupon-card-header">
                  <span class="coupon-card-icon">üéüÔ∏è</span>
                  <span class="coupon-card-amount">‚Ç¨{{ coupon.discount_amount }}</span>
                </div>
                <div class="coupon-card-code">{{ coupon.coupon_code }}</div>
                <button class="btn-use-coupon">Usar Cup√≥n</button>
              </div>
            </div>
          </div>

          <!-- Applied Coupons List -->
          <div *ngIf="appliedCoupons.length > 0" class="applied-coupons-list">
            <p class="applied-title">‚úì Cupones aplicados:</p>
            <div class="applied-coupons-items">
              <div *ngFor="let coupon of appliedCoupons" class="applied-coupon-item">
                <span class="applied-coupon-code">{{ coupon.code }}</span>
                <span class="applied-coupon-amount">-‚Ç¨{{ coupon.amount }}</span>
                <button class="btn-remove-applied" (click)="removeCoupon(coupon.code)">‚úñ</button>
              </div>
            </div>
            <button class="btn-clear-all-coupons" (click)="removeAllCoupons()">
              Eliminar todos los cupones
            </button>
          </div>

          <!-- Manual coupon input -->
          <div class="coupon-input-section">
            <p class="input-label">Agregar otro cup√≥n:</p>
            <div class="coupon-input-group">
              <input 
                type="text" 
                [(ngModel)]="couponCode" 
                placeholder="Ingresa tu cup√≥n"
              >
              <button 
                class="btn-apply-coupon" 
                (click)="applyCoupon()"
                [disabled]="!couponCode"
              >
                Aplicar
              </button>
            </div>
          </div>
        </div>

        <!-- Total Section -->
        <div class="cart-total-section">
          <div class="total-line">
            <span>Subtotal:</span>
            <span>{{ cartSubtotal | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div *ngIf="currentUser" class="total-line discount">
            <span>üéÅ Descuento usuario (10%):</span>
            <span>-{{ cartDiscount | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div *ngIf="appliedCoupons.length > 0" class="total-line discount">
            <span>üéüÔ∏è Cupones ({{ appliedCoupons.length }}):</span>
            <span>-{{ totalCouponDiscount | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-line total">
            <span><strong>Total:</strong></span>
            <span><strong>{{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}</strong></span>
          </div>
          <div *ngIf="!currentUser" class="register-promo">
            üí° ¬°Reg√≠strate y obt√©n 10% de descuento en todas tus compras!
          </div>
        </div>

        <div class="cart-actions">
          <button class="btn-clear" (click)="clearCart()">Vaciar Carrito</button>
          <button class="btn-checkout" (click)="proceedToCheckout()">Proceder al Pago</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div *ngIf="showPaymentModal" class="modal-overlay" (click)="closePaymentModal()">
    <div class="payment-modal" (click)="$event.stopPropagation()">
      <div class="payment-header">
        <h2>üí≥ M√©todo de Pago</h2>
        <button class="btn-close-modal" (click)="closePaymentModal()">‚úñ</button>
      </div>

      <div class="payment-content">
        <!-- Order Summary -->
        <div class="order-summary">
          <h3>Resumen del Pedido</h3>
          <div class="summary-line">
            <span>Subtotal:</span>
            <span>{{ cartSubtotal | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div *ngIf="currentUser" class="summary-line discount">
            <span>Descuento usuario:</span>
            <span>-{{ cartDiscount | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div *ngIf="appliedCoupons.length > 0" class="summary-line discount">
            <span>Cupones ({{ appliedCoupons.length }}):</span>
            <span>-{{ totalCouponDiscount | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div class="summary-line total">
            <span><strong>Total a pagar:</strong></span>
            <span><strong>{{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}</strong></span>
          </div>
        </div>

        <!-- Payment Methods -->
        <div class="payment-methods">
          <h3>Selecciona tu m√©todo de pago</h3>
          
          <div class="payment-options">
            <div 
              class="payment-option" 
              [class.selected]="paymentMethod === 'tarjeta'"
              (click)="selectPaymentMethod('tarjeta')">
              <div class="payment-icon">üí≥</div>
              <div class="payment-info">
                <h4>Tarjeta de Cr√©dito/D√©bito</h4>
                <p>Visa, Mastercard, American Express</p>
              </div>
              <div class="payment-check" *ngIf="paymentMethod === 'tarjeta'">‚úì</div>
            </div>

            <div 
              class="payment-option" 
              [class.selected]="paymentMethod === 'paypal'"
              (click)="selectPaymentMethod('paypal')">
              <div class="payment-icon">üÖøÔ∏è</div>
              <div class="payment-info">
                <h4>PayPal</h4>
                <p>Pago seguro con tu cuenta PayPal</p>
              </div>
              <div class="payment-check" *ngIf="paymentMethod === 'paypal'">‚úì</div>
            </div>

            <div 
              class="payment-option" 
              [class.selected]="paymentMethod === 'bizum'"
              (click)="selectPaymentMethod('bizum')">
              <div class="payment-icon">üì±</div>
              <div class="payment-info">
                <h4>Bizum</h4>
                <p>Pago instant√°neo desde tu m√≥vil</p>
              </div>
              <div class="payment-check" *ngIf="paymentMethod === 'bizum'">‚úì</div>
            </div>

            <div 
              class="payment-option" 
              [class.selected]="paymentMethod === 'efectivo'"
              (click)="selectPaymentMethod('efectivo')">
              <div class="payment-icon">üíµ</div>
              <div class="payment-info">
                <h4>Efectivo en Tienda</h4>
                <p>Paga al recoger tu pedido</p>
              </div>
              <div class="payment-check" *ngIf="paymentMethod === 'efectivo'">‚úì</div>
            </div>
          </div>
        </div>

        <!-- Pickup Points (only for cash payment) -->
        <div *ngIf="showPickupOptions" class="pickup-section">
          <h3>üìç Selecciona tu punto de recogida</h3>
          <p class="pickup-note">El pago en efectivo solo est√° disponible con recogida en tienda</p>
          
          <div class="pickup-options">
            <div 
              *ngFor="let point of pickupPoints"
              class="pickup-option"
              [class.selected]="pickupPoint === point"
              (click)="pickupPoint = point">
              <div class="pickup-icon">üè™</div>
              <div class="pickup-info">{{ point }}</div>
              <div class="pickup-check" *ngIf="pickupPoint === point">‚úì</div>
            </div>
          </div>
        </div>

        <!-- Confirm Button -->
        <div class="payment-actions">
          <button class="btn-cancel" (click)="closePaymentModal()">Cancelar</button>
          <button 
            class="btn-confirm-payment" 
            (click)="confirmPayment()"
            [disabled]="!paymentMethod || (paymentMethod === 'efectivo' && !pickupPoint)">
            Confirmar Pago
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Card Payment Modal -->
  <div *ngIf="showCardModal" class="modal-overlay" (click)="closeCardModal()">
    <div class="card-modal" (click)="$event.stopPropagation()">
      <div class="card-modal-header">
        <h2>üí≥ Datos de la Tarjeta</h2>
        <button class="btn-close-modal" (click)="closeCardModal()">‚úñ</button>
      </div>

      <div class="card-modal-content">
        <div class="card-preview">
          <div class="card-chip">üí≥</div>
          <div class="card-number-display">{{ cardNumber || '**** **** **** ****' }}</div>
          <div class="card-details">
            <div class="card-holder-display">{{ cardHolder || 'TITULAR DE LA TARJETA' }}</div>
            <div class="card-expiry-display">{{ cardExpiry || 'MM/AA' }}</div>
          </div>
        </div>

        <form class="card-form">
          <div class="form-group">
            <label>N√∫mero de Tarjeta</label>
            <input 
              type="text" 
              [(ngModel)]="cardNumber"
              (input)="formatCardNumber($event)"
              placeholder="1234 5678 9012 3456"
              maxlength="16"
              name="cardNumber">
          </div>

          <div class="form-group">
            <label>Titular de la Tarjeta</label>
            <input 
              type="text" 
              [(ngModel)]="cardHolder"
              placeholder="NOMBRE COMPLETO"
              name="cardHolder"
              style="text-transform: uppercase;">
          </div>

          <div class="form-row-card">
            <div class="form-group">
              <label>Fecha de Expiraci√≥n</label>
              <input 
                type="text" 
                [(ngModel)]="cardExpiry"
                (input)="formatExpiry($event)"
                placeholder="MM/AA"
                maxlength="5"
                name="cardExpiry">
            </div>

            <div class="form-group">
              <label>CVV</label>
              <input 
                type="text" 
                [(ngModel)]="cardCVV"
                (input)="formatCVV($event)"
                placeholder="123"
                maxlength="3"
                name="cardCVV">
            </div>
          </div>

          <div class="card-modal-actions">
            <button type="button" class="btn-cancel" (click)="closeCardModal()">Cancelar</button>
            <button type="button" class="btn-confirm-card" (click)="confirmCardPayment()">
              Pagar {{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bizum Payment Modal -->
  <div *ngIf="showBizumModal" class="modal-overlay" (click)="closeBizumModal()">
    <div class="bizum-modal" (click)="$event.stopPropagation()">
      <div class="bizum-modal-header">
        <h2>üì± Pago con Bizum</h2>
        <button class="btn-close-modal" (click)="closeBizumModal()">‚úñ</button>
      </div>

      <div class="bizum-modal-content">
        <div class="bizum-info">
          <div class="bizum-logo">üì±</div>
          <h3>Pago Instant√°neo</h3>
          <p>Introduce tu n√∫mero de tel√©fono asociado a Bizum</p>
          <div class="amount-display">
            {{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}
          </div>
        </div>

        <form class="bizum-form">
          <div class="form-group">
            <label>N√∫mero de Tel√©fono</label>
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+34</span>
              <input 
                type="tel" 
                [(ngModel)]="bizumPhone"
                (input)="formatPhone($event)"
                placeholder="612 345 678"
                maxlength="9"
                name="bizumPhone">
            </div>
            <p class="input-hint">Recibir√°s una notificaci√≥n en tu m√≥vil para confirmar el pago</p>
          </div>

          <div class="bizum-modal-actions">
            <button type="button" class="btn-cancel" (click)="closeBizumModal()">Cancelar</button>
            <button type="button" class="btn-confirm-bizum" (click)="confirmBizumPayment()">
              Enviar solicitud de pago
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
